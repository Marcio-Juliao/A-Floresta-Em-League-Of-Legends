<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <title>Ranking - A Floresta em League Of Legends</title>
    <link rel="icon" type="image/x-icon" href="../src/img/LoL_Icon_Flat_GOLD.svg">
    <link rel="stylesheet" href="../css/estatisticas.css">
    <link rel="stylesheet" href="../css/navbar-footer.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="refreshRanking(); refreshGrafico(); atualizarNavSessao();">
    <!-- Chamando duas funções no ato de carregamento do body na tela do usuário, ou seja, quase que instantaneamente -->
    <div class="header">
        <div class="container_header">
            <a href="./index.html"><img src="../src/img/LoL_Icon_Flat_GOLD.svg" class="icone_logo"></a>
            <ul class="navbar" id="ul_nav">
                <a href="./Saiba_Mais.html">
                    <li>Saiba Mais</li>
                </a>
                <a href="./Quiz.html">
                    <li>Quiz</li>
                </a>
                <a href="./Estatisticas.html">
                    <li>Estatísticas</li>
                    <a href="./Login.html">
                        <li>Login</li>
                    </a>
                    <a href="./Cadastrar.html">
                        <li>Cadastrar</li>
                    </a>
                    <li id="li_divisoria" style="display: none;">|</li>
                    <li id="li_nomeUser" style="display: none; color: aquamarine;">Nenhum</li>
                    <li id="li_sair" style="display: none;">
                        <a onclick="deslogar()">
                            Sair
                        </a>
                    </li>
            </ul>
        </div>
    </div>
    <div class="container_estatisticas">
        <div class="banner_estatisticas">
            <div class="card_estatisticas">
                <p class="titulo_estatisticas">Estatísticas Gerais</p>
                <div class="container_estatisticas">
                    <p class="titulo_grafico">
                        Porcentagem de Jogadores e Não Jogadores
                    </p>
                    <canvas id="GraficoBarras" class="grafico1_estatisticas"></canvas>
                </div>
            </div>
            <div class="card_ranking">
                <p class="titulo_ranking">Ranking Geral</p>
                <p class="subtitulo_ranking">Top 10</p>
                <div class="container_ranking" id="container_ranking"></div>
            </div>
        </div>
    </div>
    <div class="linha"></div>
    <div class="div_footer">
        <div class="container_footer">
            <ul class="footer">
                <li>
                    <p class="titulo_footer">Autor</p>
                    <p class="texto_footer">Marcio Ribeiro Julião</p>
                </li>
                <li>
                    <p class="titulo_footer">Contato</p>
                    <p class="texto_footer">marcio.juliao@sptech.school</p>
                </li>
                <li>
                    <p class="titulo_footer">Endereço</p>
                    <p class="texto_footer">R. Haddock Lobo, 595</p>
                </li>
                <li>
                    <p class="titulo_footer">Redes Sociais</p>
                    <a href="https://www.linkedin.com/in/marcio-r-juliao/" target="_blank"><img
                            src="../src/img/Imagem_Linkedin.png"></a>
                    <a href="https://github.com/Marcio-Juliao" target="_blank"><img
                            src="../src/img/Imagem_Github.png"></a>
                </li>
            </ul>
        </div>
    </div>
</body>

</html>

<script>

    // sessionStorage.clear() // -> Comando para "deslogar" (limpar o session storage)
    function deslogar() {
        sessionStorage.clear();
        atualizarNavSessao();
        alert("Sessão encerrada!");
    }

    function atualizarNavSessao() {
        var liNomeUserId = li_nomeUser;
        var liNomeUserElement = document.getElementById('li_nomeUser');

        if (sessionStorage.EMAIL_USUARIO && sessionStorage.NOME_USUARIO && sessionStorage.ID_USUARIO) {

            liNomeUserId.style.display = 'block';
            li_divisoria.style.display = 'block';
            li_sair.style.display = 'block';

            liNomeUserId.innerHTML = `${sessionStorage.NOME_USUARIO}`;
        } else {

            if (liNomeUserElement) {

                liNomeUserId.style.display = 'none';
                li_divisoria.style.display = 'none';
                li_sair.style.display = 'none';

                liNomeUserElement.innerHTML = "Nenhum";
                console.log("Nenhum usuário logado!");
            }
        }
    }

    var chart = null;  // inicializando a variável chart no escopo global, pois ela será verificada num if mais abaixo

    function fetchRanking() {
        fetch("/estatisticas/top10", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO fetchRanking!");

            if (resposta.ok) {
                resposta.json().then(json => {
                    console.log(json);
                    var respostaBanco = json; // Armazenando o JSON que veio como resposta do fetch numa variável local

                    atualizarRanking(respostaBanco); // Chamando a função que atualiza o gráfico, passando a variável local como parâmetro para evitar a criação de uma variável global
                });
            } else {
                console.log("Houve um erro ao capturar o top 10!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }
        }).catch(function (erro) {
            console.log(erro);
        });

        return false;
    }

    function fetchGrafico() {

        fetch("/estatisticas/jogadores", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO fetchGrafico!");

            if (resposta.ok) {
                resposta.json().then(json => {
                    console.log(json);

                    var respostaBanco = json; // Armazenando o JSON que veio como resposta do fetch numa variável local

                    atualizarGrafico(respostaBanco); // Chamando a função que atualiza o gráfico, passando a variável local como parâmetro para evitar a criação de uma variável global
                });
            } else {
                console.log("Houve um erro ao capturar os dados do gráfico!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }
        }).catch(function (erro) {
            console.log(erro);
        });

        return false;
    }

    function refreshRanking() {
        fetchRanking(); // Chama a função uma vez
        setInterval(fetchRanking(), 5000); // Chama a função de 5 em 5 segundos, para que as estatísticas sejam constantemente atualizadas
    }

    function refreshGrafico() {
        fetchGrafico(); // Chama a função uma vez
        setInterval(fetchGrafico(), 30000); // Chama a função de 30 em 30 segundos, para que o gráfico seja constantemente atualizado
    }

    // Função que gera dinamicamente de forma simples os elementos do top 10.
    function atualizarRanking(ranking) { // Esta função espera um parãmetro que será chamado de "ranking"
        container_ranking.innerHTML = ''; // Em primeiro momento, limpa totalmente a lista do top10

        for (var i = 0; i < ranking.length; i++) { // For que vai de 0 até o tamanho do vetor retornado pelo banco, similar a um forEach.
            var usuario = ranking[i]; // Variável para auxiliar na consumação dos dados mais a frente

            var porcentagemAcertos = (usuario.acertos / 5) * 100; // Cálculo da porcentagem dos acertos do usuário

            if (porcentagemAcertos <= 40) {
                container_ranking.innerHTML += `
            <div class="usuario_ranking"><span style="justify-self: flex-start;">${i + 1}º Lugar</span>Usuário:<span
                            style="color: aquamarine; margin-left: -10px;">${usuario.nome}</span> Acertos: <span style="color: aquamarine;">${usuario.acertos}/5</span>
                        <span>-</span><span style="color: red;">(${porcentagemAcertos}%)</span>
            </div>
        `;
            } else {
                container_ranking.innerHTML += `
                <div class="usuario_ranking"><span style="justify-self: flex-start;">${i + 1}º Lugar</span>Usuário:<span
                                style="color: aquamarine; margin-left: -10px;">${usuario.nome}</span> Acertos: <span style="color: aquamarine;">${usuario.acertos}/5</span>
                            <span>-</span><span style="color: aquamarine;">(${porcentagemAcertos}%)</span>
                </div>
            `; // Geração efetiva dos elementos dentro da lista, como está limitado a 10 pela controller, o limite sempre será 10, mas é algo suficientemente flexível no código
            }

        }
    }

    function atualizarGrafico(dados) { // Esta função espera 1 parâmetro, que aqui se chamará "dados"

        const labels = ['Já Jogou', 'Nunca Jogou']; // Constante para definir os labels, que são fixamente apenas esses dois
        var dadosBrutos = [Number(dados[0].sim), Number(dados[0].nao)]; // Separando os dados para o gráfico com base no parâmetro recebido por esta função

        var somaDadosGrafico = 0;

        for (var i = 0; i < dadosBrutos.length; i++) {
            somaDadosGrafico += dadosBrutos[i];
        }

        var dadosGrafico = [(Number((((dadosBrutos[0] / somaDadosGrafico) * 100)).toFixed(1))), Number(((dadosBrutos[1] / somaDadosGrafico)* 100).toFixed(1))]; // Cálculo da porcentagem dos dados para o gráfico

        console.log("Soma dos dados do gráfico: " + somaDadosGrafico);

        if (chart) { // Verificando se um gráfico já existe, ou seja, se há conteúdo na variável -> Esse é o motivo da variável "chart" ser global
            chart.destroy(); // Destruindo o gráfico se a condição for cumprida
        }

        const ctx = document.getElementById('GraficoBarras').getContext('2d');
        chart = new Chart(ctx, { // Pelo que eu entendo, estou instanciando um objeto da classe Chart e o armazenando numa variável global criada anteriormente
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Usuários',
                    data: dadosGrafico,
                    backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)'],
                    borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)'],
                    borderWidth: 0.5
                }]
            },
            options: {
                aspectRatio: 1.5
            }
        });
    }

</script>